{% block content %}

    <div>
        {% for flashMessage in app.session.flashbag.get('notice') %}
            <div class="flash-notice">
                {{ flashMessage}}
            </div>
        {% endfor %}

        {% for flashMessage in app.session.flashbag.get('error') %}
            <div class="flash-error">
                {{ flashMessage}}
            </div>
        {% endfor %}

        <!-- start:filter -->
        <div id="filter" class="filter">
            <form method="get" id="filter_form">
                <ul class="clearfix">
                    
                    <!--label for="sort">Sort by</label>
                    <select name="sort" id="sort" autocomplete="off">
                        <option value="b.id"{% if pagination.isSorted('b.id') %} selected="selected"{% endif %}>Id</option>
                        <option value="b.name"{% if pagination.isSorted('b.name') %} selected="selected"{% endif %}>Name</option>
                    </select>
                    <label for="direction">Direction</label>
                    <select name="direction" id="direction" autocomplete="off">
                        <option value="asc"{% if direction=='asc' %} selected="selected"{% endif %}>Ascending</option>
                        <option value="desc"{% if direction =='desc' %} selected="selected"{% endif %}>Descending</option>
                    </select-->

                    <div id="page_size_container">
                        <label for="page_size">Boats per page:</label>
                        <select name="page_size" id="page_size_select" autocomplete="off">
                            <option value="1" {% if page_size==1 %}selected="selected" {% endif %}>1</option>
                            <option value="5" {% if page_size==5 %}selected="selected" {% endif %}>5</option>
                            <option value="10" {% if page_size==10 %}selected="selected" {% endif %}>10</option>
                            <option value="25" {% if page_size==25 %}selected="selected" {% endif %}>25</option>
                            <option value="50" {% if page_size==50 %}selected="selected" {% endif %}>50</option>
                        </select>
                    </div>


                    <li>
                        <input type="text" name="boat_name" placeholder="Boat Name" {% if search_boat_name %}value="{{ search_boat_name }}{% endif %}" />
                    </li>
                    <li>
                        <select class="gray small" name="boat_type" autocomplete="off">
                            <option value="">All</option>
                            {% for boat_type in boat_types %}
                                <option value="{{ boat_type.id }}" {% if search_boat_type==boat_type.id %}selected="selected"{% endif %}>{{ boat_type.name }}</option>
                            {% endfor %}
                        </select>
                    </li>
                    <li class="submit">
                        <button type="submit" class="button blue small">Filter</button>
                    </li>
                </ul>
            </form>
        </div>
        <!-- end:filter -->

        <!-- start:trips -->
        <div id="boats" class="trips boats">
            <div class="page" id="page_{{ page }}">
                <input type="hidden" class="page_num" value="{{ page }} " />
                <input type="hidden" class="request_uri" value="{{ request_uri }} " />
                {% for boat in pagination %}
                    {% include "ZizooCharterBundle:Charter:boat_admin_bar.html.twig" with { boat: boat } %}
                {% endfor %}
            </div>
        </div>

        {# display navigation #}
        <div id="navigation_container">
            <div id="navigation">
                {{ knp_pagination_render(pagination) }}
            </div>
        </div>

        <style type="text/css">

        </style>

        <script type="text/javascript">

            function doBlock(block){
                if (block){
                    $('#navigation_container').block({ message: null }); 
                    $('#boats').block({ message: null }); 
                    $('#filter').block({ message: null });
                } else {
                    $('#navigation_container').unblock();
                    $('#boats').unblock();
                    $('#filter').unblock();
                }
            }

            function loadPage(page){
                $('#page_'+page).find('.toggle').each(function(){
                    $(this).click(function(){
                        doBlock(true);

                        var form = $(this).parent('form');
                        $('input[name=active]', form).val( $(this).hasClass("off") ? 0 : 1 );
                        
                        $.ajax({
                            type: 'post', 
                            url: '{{ path('ZizooBoatBundle_Boat_Active') }}',
                            data: $(this).parent('form').serialize(),
                            success: function(data, textStatus, XHR){
                                doBlock(false);
                            }
                        });
                    });
                });
            }

            function setupFilter(){

                $('#navigation_container').prepend($('#page_size_container'));
                $('#filter_form').append('<input id="page_size" name="page_size" type="hidden" />');
                $('#page_size_select').change(function(){
                    $('#page_size').val($(this).val());
                    $('#filter_form').submit();
                });
                 $('#page_size').val($('#page_size_select').val());

                $('#filter_form').submit(function(){
                    doBlock(true);
                    $.ajax({
                        type: 'get',
                        data: $('#filter_form').serialize(),
                        success: function(data, textStatus, XHR){
                            var newPage = $(data).find('#boats .page_num').val();
                            var newUrl = $(data).find('#boats .request_uri').val();
                            $('#boats').html($(data).find('#boats'));
                            $('#navigation').html($(data).find('#navigation'));
                            loadPage(newPage);
                            window.history.pushState('string', 'title', newUrl);
                            doBlock(false);
                        }
                    });
                    return false;
                });
            }

            $(document).ready(function(){

                setupFilter();

                $('#navigation').delegate('a', 'click', function(){
                    doBlock(true);
                    var newUrl = $(this).attr('href');
                    $.ajax({
                        type: 'get', 
                        url: newUrl,
                        success: function(data, textStatus, XHR){
                            var newPage = $(data).find('#boats .page_num').val();
                            $('#boats').html($(data).find('#boats'));
                            $('#navigation').html($(data).find('#navigation'));
                            loadPage(newPage);
                            window.history.pushState('string', 'title', newUrl);
                            doBlock(false);
                        },
                        failure: function(data, textStatus, XHR){
                            doBlock(false);
                        }
                    });
                    return false;
                });

                loadPage({{ page }});

            });

        </script>
        
    </div>
    
{% endblock %}
{% block stylesheets %}
    <link href="{{ asset('bundles/zizoojqgridcustom/css/ui.jqgrid-custom.css') }}" type="text/css" rel="stylesheet" />
    <link href="{{ asset('css/custom_combobox.css') }}" type="text/css" rel="stylesheet" />

    <style type="text/css">

        .dataTables_length {
            display: none;
        }

        .dataTables_filter {
            display: none;
        }
    </style>
{% endblock %}
    
{% block javascripts %}

    <script src="{{ asset('js/main.js') }}" type="text/javascript"></script>
    <script type="text/javascript" src="{{ asset('bundles/zizoojqgridcustom/js/i18n/grid.locale-en.js') }}"></script>
    <script type="text/javascript" src="{{ asset('bundles/zizoojqgridcustom/js/jquery.jqGrid.src.js') }}"></script>
    <script type="text/javascript" src="{{ asset('bundles/zizoojqgridcustom/js/jquery.contextmenu-ui.js') }}"></script>
    <script type="text/javascript" src="{{ asset('js/custom_combobox.js') }}"></script>
    <script type="text/javascript" src="http://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.4/jquery.dataTables.min.js"></script>
    <script src="{{ asset('bundles/zizoobase/js/zizoo-datatables.js') }}"></script>

    <script>

        $.fn.dataTableExt.afnFiltering.push(
            function( oSettings, aData, iDataIndex ) {
                var iFini = $("#custom_filter input[name=start_date]").val();
                var iFfin = $("#custom_filter input[name=end_date]").val();
                
                var iDateCol = 3;
                 
                iFini=iFini.substring(0,4) + iFini.substring(5,7)+ iFini.substring(8,10);
                iFfin=iFfin.substring(0,4) + iFfin.substring(5,7)+ iFfin.substring(8,10);      
                 
                var datofini=aData[iDateCol].substring(0,4) + aData[iDateCol].substring(5,7)+ aData[iDateCol].substring(8,10);
                 
                if ( iFini == "" && iFfin == "" )
                {
                    return true;
                }
                else if ( iFini <= datofini && iFfin == "")
                {
                    return true;
                }
                else if ( iFfin >= datofini && iFini == "")
                {
                    return true;
                }
                else if (iFini <= datofini && iFfin >= datofini)
                {
                    return true;
                }
                return false;
            }
        );

        $.fn.dataTableExt.afnFiltering.push(
            function( oSettings, aData, iDataIndex ) {
                var filter = $("#custom_filter input[name=booking]").val();
                var value = aData[0];
                
                if(filter == "")
                    return true;

                if(value.toLowerCase().indexOf(filter.toLowerCase()) >= 0)
                    return true;

                return false;
            }
        );

        $.fn.dataTableExt.afnFiltering.push(
            function( oSettings, aData, iDataIndex ) {
                var filter = $("#custom_filter input[name=boat]").val();
                var value = aData[1];
                
                if(filter == "")
                    return true;

                if(value.toLowerCase().indexOf(filter.toLowerCase()) >= 0)
                    return true;

                return false;
            }
        );

        $.fn.dataTableExt.afnFiltering.push(
            function( oSettings, aData, iDataIndex ) {
                var filter = $("#custom_filter input[name=guest]").val();
                var value = aData[2];
                
                if(filter == "")
                    return true;

                if(value.toLowerCase().indexOf(filter.toLowerCase()) >= 0)
                    return true;

                return false;
            }
        );

        $(document).ready(function() {

            $('#table_payments').dataTable({
                "sPaginationType": "zizo_pagination",
                
                "bInfo": false
                
            });

            var oTable = $('#table_payments').dataTable();
             
            /* Add event listeners to the two range filtering inputs */
            $("#custom_filter input").change( function() { oTable.fnDraw(); } );
            $("#custom_filter input").keyup( function() { oTable.fnDraw(); } );
        } );

    </script>

{% endblock %}

{% block content %}

    {% for flashMessage in app.session.flashbag.get('notice') %}
        <div class="flash-notice">
            {{ flashMessage}}
        </div>
    {% endfor %}

    {% for flashMessage in app.session.flashbag.get('error') %}
        <div class="flash-error">
            {{ flashMessage}}
        </div>
    {% endfor %}

    <!-- start:filter -->
    <div id="custom_filter" class="filter">
        <form action="#">
            <ul class="clearfix">
                <li><input name="booking" type="text" placeholder="Booking"></li>
                <li><input name="boat" type="text" placeholder="Boat"></li>
                <li><input name="guest" type="text" placeholder="Guest"></li>

                <li><input name="start_date" type="text" class="date-picker start" value="2013-07-09" ></li>
                <li><input name="end_date" type="text" class="date-picker end" value="2013-07-10" ></li>
            </ul>
        </form>
    </div>
    <!-- end:filter -->

    <!-- start:table -->
    <div class="responsive-table clearfix">
        <table id="table_payments">
            <thead>
                <tr>
                    <th>Booking</th>
                    <th>Boat</th>
                    <th>Guest</th>
                    <th>Date</th>
                    <th>Total</th>
                    <th>Received</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Z00354</td>
                    <td>Princess 01/31/2013</td>
                    <td>Daddo</td>
                    <td>2013-07-05</td>
                    <td>6200 &euro;</td>
                    <td>1900 &euro;</td>
                </tr>
                <tr>
                    <td>Z00354</td>
                    <td>Princess 01/31/2013</td>
                    <td>Haddo</td>
                    <td>2013-07-05</td>
                    <td>6200 &euro;</td>
                    <td>1900 &euro;</td>
                </tr>
                <tr>
                    <td>Z00354</td>
                    <td>Princess 01/31/2013</td>
                    <td>Haddo</td>
                    <td>2013-07-05</td>
                    <td>6200 &euro;</td>
                    <td>1900 &euro;</td>
                </tr>
                <tr>
                    <td>Z00354</td>
                    <td>Princess 01/31/2013</td>
                    <td>Haddo</td>
                    <td>2013-07-05</td>
                    <td>6200 &euro;</td>
                    <td>1900 &euro;</td>
                </tr>
                <tr>
                    <td>Z00354</td>
                    <td>Princess 01/31/2013</td>
                    <td>Haddo</td>
                    <td>2013-07-05</td>
                    <td>6200 &euro;</td>
                    <td>1900 &euro;</td>
                </tr>
                <tr>
                    <td>Z00354</td>
                    <td>Princess 01/31/2013</td>
                    <td>Haddo</td>
                    <td>2013-07-05</td>
                    <td>6200 &euro;</td>
                    <td>1900 &euro;</td>
                </tr>
                <tr>
                    <td>Z00354</td>
                    <td>Princess 01/31/2013</td>
                    <td>Haddo</td>
                    <td>2013-07-05</td>
                    <td>6200 &euro;</td>
                    <td>1900 &euro;</td>
                </tr>
                <tr>
                    <td>Z00354</td>
                    <td>Princess 01/31/2013</td>
                    <td>Haddo</td>
                    <td>2013-07-05</td>
                    <td>6200 &euro;</td>
                    <td>1900 &euro;</td>
                </tr>
                <tr>
                    <td>Z00354</td>
                    <td>Princess 01/31/2013</td>
                    <td>Haddo</td>
                    <td>2013-07-05</td>
                    <td>6200 &euro;</td>
                    <td>1900 &euro;</td>
                </tr>
                <tr>
                    <td>Z00354</td>
                    <td>Princess 01/31/2013</td>
                    <td>Haddo</td>
                    <td>2013-07-05</td>
                    <td>6200 &euro;</td>
                    <td>1900 &euro;</td>
                </tr>
                <tr>
                    <td>Z00354</td>
                    <td>Princess 01/31/2013</td>
                    <td>Haddo</td>
                    <td>2013-07-05</td>
                    <td>6200 &euro;</td>
                    <td>1900 &euro;</td>
                </tr>
                <tr>
                    <td>Z00354</td>
                    <td>Princess 01/31/2013</td>
                    <td>Haddo</td>
                    <td>2013-07-05</td>
                    <td>6200 &euro;</td>
                    <td>1900 &euro;</td>
                </tr>
                <tr>
                    <td>Z00354</td>
                    <td>Princess 01/31/2013</td>
                    <td>Haddo</td>
                    <td>2013-07-05</td>
                    <td>6200 &euro;</td>
                    <td>1900 &euro;</td>
                </tr>
                <tr>
                    <td>Z00354</td>
                    <td>Princess 01/31/2013</td>
                    <td>Haddo</td>
                    <td>2013-07-05</td>
                    <td>6200 &euro;</td>
                    <td>1900 &euro;</td>
                </tr>
                <tr>
                    <td>Z00354</td>
                    <td>Princess 01/31/2013</td>
                    <td>Haddo</td>
                    <td>2013-07-05</td>
                    <td>6200 &euro;</td>
                    <td>1900 &euro;</td>
                </tr>
                <tr>
                    <td>Z00354</td>
                    <td>Princess 01/31/2013</td>
                    <td>Haddo</td>
                    <td>2013-07-05</td>
                    <td>6200 &euro;</td>
                    <td>1900 &euro;</td>
                </tr>
            </tbody>
        </table>
    </div>
    <!-- end:table -->
    
    <div class="contextMenu" id="contextMenu" style="display: none">
        <ul style="width: 400px">
            <li id="open">
                <span class="ui-icon ui-icon-folder-open" style="float:left"></span>
                <span style="font-size:11px; font-family:Verdana">Open</span>
            </li>
            <li id="view_guest_profile">
                <span class="ui-icon ui-icon-search" style="float:left"></span>
                <span style="font-size:11px; font-family:Verdana" >View guest profile</span>
            </li>
        </ul>
    </div>        
    
    <script type="text/javascript">

        function openBooking(bookingId){
            var url = '{{ path('ZizooCharterBundle_Charter_ViewBooking', {id: '_replaceme_'}) }}';
            url = url.replace('_replaceme_', bookingId)
            window.location.href = url;
        }
        
        function openGuestProfile(guestUsername){
            var url = '{{ path('ZizooProfileBundle_Profile_Show', {username: '_replaceme_'}) }}';
            url = url.replace('_replaceme_', guestUsername)
            window.location.href = url;
        }

        function bookingDoubleClick(rowId, rowIndex, colIndex, e){
            var bookingId = jQuery('#{{ grid.name|raw }}').jqGrid('getCell', rowId, 'grid_paymentsreservation_id');
            openBooking(bookingId);
        }

        function createBookingSearch(elem){
            $(elem).attr('class', 'search');
            var id = $(elem).attr('id');
            var newSelect = $('<select id="'+id+'_search" class="zizoo_combobox">{% for status_id, status_val in grid.extraParams['bookingOptions'] %}<option value="{{ status_id }}">{{ status_val }}</option>{% endfor %}</select>').hide();
            $(elem).hide().after(newSelect);
        }
        
        function createBoatSearch(elem){
            $(elem).attr('class', 'search');
            var id = $(elem).attr('id');
            var newSelect = $('<select id="'+id+'_search" class="zizoo_combobox">{% for status_id, status_val in grid.extraParams['boatOptions'] %}<option value="{{ status_id }}">{{ status_val }}</option>{% endfor %}</select>').hide();
            $(elem).hide().after(newSelect);
        }
        
        function createGuestSearch(elem){
            $(elem).attr('class', 'search');
            var id = $(elem).attr('id');
            var newSelect = $('<select id="'+id+'_search" class="zizoo_combobox">{% for status_id, status_val in grid.extraParams['guestOptions'] %}<option value="{{ status_id }}">{{ status_val }}</option>{% endfor %}</select>').hide();
            $(elem).hide().after(newSelect);
        }
        
        function resizeColumn(newWidth, index){
            var comboSpan = $('#gview_{{ grid.name }} tr.ui-search-toolbar th:eq('+index+') span.custom-combobox');
            $(comboSpan).width(newWidth);
            var input = $(comboSpan).children('input.custom-combobox-input');
            $(input).width(newWidth-31);
        }
        
        function setupContextMenu(grid){
            $("tr.jqgrow", grid).contextMenu('contextMenu', {
                bindings: {
                    'open': function(trigger) {
                        // trigger is the DOM element ("tr.jqgrow") which is triggered
                        var bookingId = jQuery('#{{ grid.name|raw }}').jqGrid('getCell', trigger.id, 'grid_paymentsreservation_id');
                        openBooking(bookingId);
                    },
                    'view_guest_profile': function(trigger) {
                        // trigger is the DOM element ("tr.jqgrow") which is triggered
                        var guestUsername = jQuery('#{{ grid.name|raw }}').jqGrid('getCell', trigger.id, 'grid_paymentsguest_username');
                        openGuestProfile(guestUsername);
                    }
                },
                onContextMenu: function(event/*, menu*/) {
                    var rowId = $(event.target).closest("tr.jqgrow").attr("id");
                    jQuery('#{{ grid.name|raw }}').jqGrid('setSelection', rowId);
                    var isRead = jQuery('#{{ grid.name|raw }}').jqGrid('getCell',rowId,'{{ grid.name|raw }}IsRead') == 'true';
                    if (isRead){
                        $('#contextMenu #mark_read').hide();
                        //$('#contextMenu #mark_unread').show();
                    } else {
                        $('#contextMenu #mark_read').show();
                        //$('#contextMenu #mark_unread').hide();
                    }
                    return true;
                }
            });
        }
        
        function loadComplete(){
            setupContextMenu(this);
            
            $('#gview_{{ grid.name }} .ui-search-toolbar .zizoo_combobox').each(function(index,el){
                $(el).combobox({    select: function(val, option){ 
                                        var sel = $(option.item).parent();
                                        var actualInput = $(sel).parent().children('input.search');
                                        $(actualInput).val($(option.item).val());
                                        $(actualInput).trigger(jQuery.Event( 'keypress', { charCode: $.ui.keyCode.ENTER } ));
                                    },
                                    keypress: function(e){
                                        if (e.keyCode==13){
                                            var input = $(e.currentTarget);
                                            var actualInput = $(input).parent().parent().children('input.search');
                                            $(actualInput).val($(input).val());
                                            $(actualInput).trigger(jQuery.Event( 'keypress', { charCode: $.ui.keyCode.ENTER } ));
                                        }
                                    },
                                    autocompletechange: function(e){}
                });
                var th = $(el).parent().parent();
                resizeColumn($(th).width(), $(th).index());
            });
            
        }
        
        $(document).ready(function(){
            
            jQuery('#{{ grid.name|raw }}').jqGrid('setGridParam', { ondblClickRow: bookingDoubleClick } );
        });
        
    </script>
    
{% endblock %}
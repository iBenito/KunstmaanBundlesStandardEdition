<form action="{{ path(url) }}" method="post" {{ form_enctype(form) }} class="form">

    <div class="block borderless">
        {% set dom = form_widget(form.skills.vars.prototype)|extractJavaScript %}
        <ul class="skills" data-prototype="{{ dom[0]|e }}" data-js-prototype="{{ dom[1]|e }}">
            {# iterate over each existing skill and render #}
            {% for skill in form.skills %}
                <li>
                    {{ form_widget(skill) }}
                    {{ form_errors(skill) }}
                </li>
            {% endfor %}
        </ul>
    </div>

    {{ form_errors(form) }}
    {{ form_rest(form) }}

    <div class="row right">
        <button type="submit" class="button blue">Save</button>
    </div>

</form>

<div id="context_hidden" style="display: none">
    <div id="delete_license">
        <p>
            Are you sure you want to delete this license?
        </p>

        <br />
        <input type="button" value="Delete" class="submit_btn button red small right" />
        <input type="button" value="Cancel" class="cancel_btn button grey small right" />
    </div>
</div>

<script type="text/javascript">
    // Get the ul that holds the collection of tags
    var collectionHolder = $('ul.skills');

    // setup an "add a skill" link
    var $addSkillLink = $('<a href="#" class="add_skill_link">Add Skill</a>');
    var $newLinkLi = $('<div class="control"></div>').append($addSkillLink);
    var uploadedFiles = new Array();

    function removeUploadedFiles(index){
        for (var i=0; i<uploadedFiles.length; i++){
            eval('zizoo_crewbundle_skilltype_skills_'+index+'_license_dropzone_api.removeFile(uploadedFiles[i])');
           // zizoo_charter_logo_dropzone_api.removeFile(uploadedFiles[i]);
        }
        uploadedFiles = new Array();
    }

    function getLicense(index){
        $.ajax({
            url:        '{{ path('ZizooCrewBundle_Skills_GetLicense') }}',
            type:       'get',
            success:    function(data, textStatus, XHR){

                var newImageDivContainer    = $(data).find('#zizoo_crewbundle_skilltype_skills_'+index+'_license_media_div_container');
                $('#zizoo_crewbundle_skilltype_skills_'+index+'_license_media_div_container').html($(newImageDivContainer).html());

                removeUploadedFiles(index);

                var src = $(newImageDivContainer).find('.controls .full_url').val();

            }
        });
    }

    function licenseUploadError(file, response, dropzone){

    }

    function licenseUploadSuccess(file, response, dropzone){
        if (file!=null) uploadedFiles.push(file);
        var clickableElements = dropzone.clickableElements;
        var index = $(clickableElements[0]).parents('li').index();
        var skillId = $('#zizoo_crewbundle_skilltype_skills_'+index+'_skill').val();
        if (skillId=='') $('#zizoo_crewbundle_skilltype_skills_'+index+'_skill').val(response.skill_id);

        var licenseId = $('#zizoo_crewbundle_skilltype_skills_'+index+'_license_id').val();
        if (licenseId=='') $('#zizoo_crewbundle_skilltype_skills_'+index+'_license_id').val(response.license_id);
        getLicense(index);
    }

    function licensePreUpload(file, xhr, formData, dropzone){
        var clickableElements = dropzone.clickableElements;
        var index = $(clickableElements[0]).parents('li').index();
        var skillId = $('#zizoo_crewbundle_skilltype_skills_'+index+'_skill').val();
        formData.append('skill_id', skillId);
    }

    function licenseCrop(id, x1, y1, x2, y2, w, h){
        $.ajax({
            url:            '{{ path('ZizooMediaBundle_Media_CropMedia') }}',
            type:           'post',
            data: {
                id:             id,
                entity_type:    'ZizooCrewBundle:SkillLicense',
                x1:             x1,
                y1:             y1,
                x2:             x2,
                y2:             y2,
                w:              w,
                h:              h
            },
            success: function(data){
                var index = $('.skills li .media_id[value="'+id+'"]').parents('li').index();
                var dropzone = eval('zizoo_crewbundle_skilltype_skills_'+index+'_license_dropzone_api');
                licenseUploadSuccess(null,{id: id}, dropzone);
            }
        });
    }

    function openDeleteDialog(){
        $('#delete_license').dialog({
            title: 'Delete license?',
            width: 470,
            maxWidth: 470,
            fluid: true,
            modal: true,
            closeOnEscape: false,
            resizable: false
        });
    }

    function closeDeleteDialog(){
        $('#delete_license').dialog('close');            
        $('#delete_license').unblock();
    }

    function licenseDelete(container){
        var id  = $(container).find('.media_id').val();

        $('#delete_license .submit_btn').unbind('click').click(function(){
            $('#delete_license').block({ message: '' });
            $.ajax({
                url:            '{{ path('ZizooMediaBundle_Media_DeleteMedia') }}',
                type:           'post',
                data: {
                    id:             id,
                    entity_type:    'ZizooCrewBundle:SkillLicense'
                },
                success: function(data){
                    $(container).find('.media_div').html('');
                    closeDeleteDialog();
                },
                error: function(jqXHR, statusText, errorThrown){
                    //console.log(jqXHR);
                }
            });
        });

        $('#delete_license .cancel_btn').unbind('click').click(function(){
            closeDeleteDialog();
        });

        openDeleteDialog();

    }

    function addSkillForm(collectionHolder, $newLinkLi) {
        // Get the data-prototype explained earlier
        var prototype = collectionHolder.data('prototype');
        var jsPrototype = collectionHolder.data('js-prototype');

        // get the new index
        var index = collectionHolder.data('index');

        // Replace '__name__' in the prototype's HTML to
        // instead be a number based on how many items we have
        var newForm     = prototype.replace(/__name__/g, index);
        var newScript   = jsPrototype.replace(/__name__/g, index);

        // increase the index with one for the next item
        collectionHolder.data('index', index + 1);

        // Display the form in the page in an li, before the "Add a skill" link li
        var $newFormLi = $('<li></li>').append($(newForm).children());

        collectionHolder.append($newFormLi);


        $newFormLi.find('.row').each(function(index, row){
           $(row).addClass('root').find('label, .row-content').addClass('root');
        });
        $newFormLi.find('select[multiple]').asmSelect();
        $newFormLi.find('select:not([no-select-box-it])').selectBoxIt();

        $('body').append(newScript);


        // add a delete link to the new form
        addSkillFormDeleteLink($newFormLi);
    }

    function addSkillFormDeleteLink($tagFormLi) {
        var $removeFormA = $('<a href="#">Delete this skill</a>');
        $tagFormLi.append($removeFormA);

        $removeFormA.on('click', function(e) {
            // prevent the link from creating a "#" on the URL
            e.preventDefault();

            // remove the li for the tag form
            $tagFormLi.remove();
        });
    }

    jQuery(document).ready(function() {

        // add the "add a skill" anchor and li to the skills ul
        collectionHolder.after($newLinkLi);

        // count the current form inputs we have (e.g. 2), use that as the new
        // index when inserting a new item (e.g. 2)
        collectionHolder.data('index', collectionHolder.children('li').length);

        $addSkillLink.on('click', function(e) {
            // prevent the link from creating a "#" on the URL
            e.preventDefault();

            // add a new tag form (see next code block)
            addSkillForm(collectionHolder, $newLinkLi);
        });

        collectionHolder.children('li:not(.control)').each(function(){
            addSkillFormDeleteLink($(this));
        });
    });
</script>
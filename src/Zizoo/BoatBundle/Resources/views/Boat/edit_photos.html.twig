{% set step = app.session.get('step') %}

{% block tabs %}
    {{ render(controller('ZizooBaseBundle:Dashboard:charterTabs', { 'current': 'boats' })) }}
{% endblock %}

{% include 'ZizooBoatBundle:Boat:boat_navigation.html.twig' with { 'boat': boat, 'current_route': routes['boat_photos_route'], 'routes': routes }  %}

<div class="content">
    {% if step != "" %}
        <h1>Step {{ step }}</h1>
    {% endif %}
    {% for flashMessage in app.session.flashbag.get('notice') %}
        <div class="flash-notice">
            {{ flashMessage}}
        </div>
    {% endfor %}

    <h2>Boat Gallery</h2>

    <form class="form" action="{{ path(routes['boat_photos_route'], { 'id': boat.id }) }}" method="post" {{ form_enctype(form) }}>
        {{ form_widget(form) }}
        
        {% if step != "" %}
            <button type="submit" class="button blue">Continue</button>
        {% else %}
            <button type="submit" class="button blue">Save</button>
        {% endif %}
        <input id="override_url" name="override_url" type="hidden" value="" />
    </form>
    
    <div id="context_hidden" style="display: none">
        <div id="delete_photo">
            <p>
                Are you sure you want to delete this photo?
            </p>
            
            <br />
            <input type="button" value="Delete" class="submit_btn button red small right" />
            <input type="button" value="Cancel" class="cancel_btn button grey small right" />
        </div>
    </div>
    
    <script type="text/javascript">
        var uploadedFiles = new Array();

        function removeUploadedFiles(){
            for (var i=0; i<uploadedFiles.length; i++){
                zizoo_boat_image_image_dropzone_api.removeFile(uploadedFiles[i]);
            }
            uploadedFiles = new Array();
        }

        function getPhotos(){
            $.ajax({
                url:        '{{ path('ZizooBoatBundle_Boat_GetPhotos', {id: boat.id}) }}',
                type:       'post',
                data:       {
                    routes: {{ routes|json_encode|raw }}
                },
                success:    function(data, textStatus, XHR){
                    var newPhotos = $(data).find('#zizoo_boat_image_image_list .zizoo_media_container');
                    $('#zizoo_boat_image_image_list .zizoo_media_container').remove();
                    for (var i=newPhotos.length-1; i>=0; i--){
                        $('#zizoo_boat_image_image_list').prepend(newPhotos[i]);
                    }
                    removeUploadedFiles();
                }
            });
        }

        function photoUploadError(file, response){
            var queuedFiles     = zizoo_boat_image_image_dropzone_api.getQueuedFiles();
            var uploadingFiles  = zizoo_boat_image_image_dropzone_api.getUploadingFiles();
            if (queuedFiles.length>0 || uploadingFiles.length>0 || uploadedFiles.length==0) return;

            getPhotos();
        }

        function photoUploadSuccess(file, response){
            if (file!=null) uploadedFiles.push(file);
            var queuedFiles     = zizoo_boat_image_image_dropzone_api.getQueuedFiles();
            var uploadingFiles  = zizoo_boat_image_image_dropzone_api.getUploadingFiles();
            if (queuedFiles.length>0 || uploadingFiles.length>0) return;

            getPhotos();
        }

        function photoCrop(id, x1, y1, x2, y2, w, h){
            $.ajax({
                url:            '{{ path('ZizooMediaBundle_Media_CropMedia') }}',
                type:           'post',
                data: {
                    id:             id,
                    entity_type:    'ZizooBoatBundle:BoatImage',
                    x1:             x1,
                    y1:             y1,
                    x2:             x2,
                    y2:             y2,
                    w:              w,
                    h:              h
                },
                success: function(data){
                    photoUploadSuccess(null,{id: id});
                }
            });
        }

        function openDeleteDialog(){
            $('#delete_photo').dialog({
                title: 'Delete photo?',
                width: 470,
                maxWidth: 470,
                fluid: true,
                modal: true,
                closeOnEscape: false,
                resizable: false
            });
        }

        function closeDeleteDialog(){
            $('#delete_photo').dialog('close');            
            $('#delete_photo').unblock();
        }
        
        function photoDelete(container){
            var id  = $(container).find('.media_id').val();

            $('#delete_photo .submit_btn').unbind('click').click(function(){
                $('#delete_photo').block({ message: '' });
                $.ajax({
                    url:            '{{ path('ZizooMediaBundle_Media_DeleteMedia') }}',
                    type:           'post',
                    data: {
                        id:             id,
                        entity_type:    'ZizooBoatBundle:BoatImage'
                    },
                    success: function(data){
                        $(container).remove();
                        closeDeleteDialog();
                    },
                    error: function(jqXHR, statusText, errorThrown){
                        //console.log(jqXHR);
                    }
                });
            });
            
            $('#delete_photo .cancel_btn').unbind('click').click(function(){
                closeDeleteDialog();
            });
            
            openDeleteDialog();
            
        }

        $(document).ready(function(){
            changed = false;
        });

    </script>
</div>


<?php

namespace Zizoo\BoatBundle\Entity;

use Doctrine\ORM\EntityRepository;
use Doctrine\ORM\Tools\Pagination\Paginator;

/**
 * BoatRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class BoatRepository extends EntityRepository
{
    public function getBoats($limit = null)
    {
        $qb = $this->createQueryBuilder('b')
                   ->select('b')
                   ->addOrderBy('b.created', 'DESC');

        if (false === is_null($limit))
            $qb->setMaxResults($limit);

        return $qb->getQuery()
                  ->getResult();
    }
    
    /**
     * 
     * @param string $search      Optional location search value
     * @param string $resFrom     Optional date from
     * @param string $resTo       Optional date until
     * @param string $numGuests   Optional number of guests
     * @return Doctrine\ORM\AbstractQuery[] Results
     * @author Alex Fuckert <alexf83@gmail.com>
     */
    public function searchBoatAvailability($search='-1', $resFrom='', $resTo='', $numGuests='')
    {
        // Join boat, image, address, country and reservation
        $qb = $this->createQueryBuilder('b')
                   ->select('b, i, a, c, r')
                   ->leftJoin('b.image', 'i')
                   ->leftJoin('b.addresses', 'a')
                   ->leftJoin('b.reservation', 'r')
                   ->leftJoin('a.country', 'c');
        
        // Optionally search by location
        $firstWhere = false;
        if ($search!='-1'){
            $qb->where('a.locality = :search')
               ->orWhere('a.subLocality = :search')
               ->orWhere('a.state = :search')
               ->orWhere('a.province = :search')
               ->orWhere('c.printableName = :search')
               ->setParameter('search', $search);
            $firstWhere = true;
        }
        
        // Optionally restrict by date range
        if ($resFrom!='' && $resTo!=''){
            // Get boat ids of all reservations. These will be excluded from results.
            $reservations = $this->getEntityManager()->getRepository('ZizooBookingBundle:Reservation')->getReservationBoatIds($resFrom, $resTo);                        
            
            $reservationsArr = array();
            foreach ($reservations as $reservation){
                $reservationsArr[] = $reservation->getBoat()->getId();
            }
            
            if (count($reservationsArr)>0){
                if ($firstWhere){
                    $qb->andWhere($qb->expr()->notIn('b.id',   implode(',', $reservationsArr)));
                } else {
                    $qb->where($qb->expr()->notIn('b.id', implode(',', $reservationsArr)));
                }
            }
           
            $firstWhere = true;
        }
        
        // Optionally restrict by number of guests
        if ($numGuests!=''){
            if ($firstWhere){
                $qb->where('b.nr_guests >= :num_guests');
            } else {
                $qb->andWhere('b.nr_guests >= :num_guests');
            }
            $qb->setParameter('num_guests', $numGuests);
            $firstWhere = true;
        }
         
        $qb->addOrderBy('b.created', 'DESC');
        
        return $qb->getQuery()
                  ->getResult();
    }
    
    
}

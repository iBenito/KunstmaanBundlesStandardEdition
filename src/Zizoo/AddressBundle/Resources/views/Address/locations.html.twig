{# src/Zizoo/AddressBundle/Resources/views/Address/locations_test.html.twig #}
{% trans_default_domain "labels" %}
{% extends 'ZizooAddressBundle::layout.html.twig' %}

{% block body %}
<form id="search_form" action="{{ path('zizoo_address_locations') }}" method="get">
    {% render "ZizooAddressBundle:Address:uniqueLocations" with {'current': current} %}
    <input type="submit" value="Search" />
</form>
<div id="map_div">
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
    <script type="text/javascript" src="http://google-maps-utility-library-v3.googlecode.com/svn/tags/markermanager/1.0/src/markermanager.js"></script>
    <script type="text/javascript" src="http://google-maps-utility-library-v3.googlecode.com/svn/trunk/markerclusterer/src/markerclusterer_compiled.js"></script>
    <script type="text/javascript" src="{{ asset('js/jquery.blockUI.js') }}"></script>
    <div id="map"></div>

    <style type="text/css">
    #map {
        width: 100%;
        height: 400px;
    }
    
    #boats .page {
        display: none;
    }
    
    #boats .page.current {
        display: block;
    }
    </style>
    
    
    <script type="text/javascript">
        var currentPage = {{ page }};
        var map = null;
        var markers = null;
        var mc = null;
        var geocoder = null;
        var center = new google.maps.LatLng(38, 15);
        var zoom = 2;
        
        function updateSearch(page){
            $('#map').block({ message: null }); 
            $('#boats').block({ message: null }); 
            var index = $('#unique_locations :selected').index();

            var type;
            var val = null;
            var search = null;
            if (index>0){
                type = $('#unique_locations option:nth-of-type('+(index+1)+')').attr('class');
                search = $('#unique_locations option:nth-of-type('+(index+1)+')').attr('search');
                val  = $('#unique_locations').val();
            }

            var sep = '?';
            var url ='{{ path('zizoo_address_locations') }}';
            if (page!=null){
                url += sep + 'page='+page;
                sep = '&';
            }
            if (val!=null) {
                url += sep + 'search='+val;
                sep = '&';
            }
            url = encodeURI(url);
            $('#boats').load(url, function(){
                if(val==null){
                    map.setCenter(center);
                    map.setZoom(zoom);
                } else {
                    codeAddress(search);
                    map.setZoom(5);
                }
                $('#map').unblock();
                $('#boats').unblock();
            });

        }
        
        function codeAddress(address) {
            geocoder.geocode( { 'address': address}, function(results, status) {
                if (status == google.maps.GeocoderStatus.OK) {
                    map.setCenter(results[0].geometry.location);
                } else {
                    alert('Geocode was not successful for the following reason: ' + status);
                }
            });
        }
        
        /**
        * Initializes the map and listeners.
        */
        function initialize() {
            geocoder = new google.maps.Geocoder();
            map = new google.maps.Map(document.getElementById('map'), {
                center: center,
                zoom: zoom,
                mapTypeId: 'terrain'
            });
            markers = new Array();
            mc = new MarkerClusterer(map, markers, {maxZoom: 19});
            //updateSearch();
        }

        $(document).ready(function(){

            if(typeof google === 'undefined' || google==null){
                $('#map').hide();
                return;
            }
            initialize();

            $('#unique_locations').chosen();
            
            jQuery('#search_form').on('submit', function(){
                updateSearch();
                return false;
            });

        });

    </script>
    <div id="boats">
        {% include "ZizooAddressBundle:Address:locations_boats.html.twig" with {'page': page, 'page_size': page_size } %}
    </div>
    
</div>
{% endblock %}
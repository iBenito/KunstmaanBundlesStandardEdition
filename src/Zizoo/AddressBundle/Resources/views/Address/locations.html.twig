{# src/Zizoo/AddressBundle/Resources/views/Address/locations_test.html.twig #}
{% trans_default_domain "labels" %}

{% extends 'ZizooAddressBundle::layout.html.twig' %}

{% block javascripts %}
    {{ parent() }}
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
    <script type="text/javascript" src="http://google-maps-utility-library-v3.googlecode.com/svn/tags/markermanager/1.0/src/markermanager.js"></script>
    <script type="text/javascript" src="http://google-maps-utility-library-v3.googlecode.com/svn/trunk/markerclusterer/src/markerclusterer_compiled.js"></script>
    <script type="text/javascript" src="{{ asset('js/jquery.blockUI.js') }}"></script>
    <script type="text/javascript" src="{{ asset('js/chosen.jquery.min.js') }}"></script>
    <script type="text/javascript" src="{{ asset('bundles/zizooaddress/js/locations.js') }}"></script>
{% endblock %}


{% block stylesheets %}
    {{ parent() }}
    <link href="{{ asset('css/chosen.css') }}" type="text/css" rel="stylesheet" />
    <link href="{{ asset('bundles/zizooaddress/css/locations.css') }}" type="text/css" rel="stylesheet" />
{% endblock %}


{% block search_results %}

    <div id="all">
        {% include "ZizooAddressBundle:Address:locations_boats.html.twig" with {'pagination': pagination } %}
    </div>
    
{% endblock search_results %}
    
{% block search_filter %}
    
    <div id="filter-controls" >
        {{ form_widget(filter_form) }}
    </div>
        
    <script type="text/javascript">
        
        function doBlock(block){
            if (block){
                $('#map').block({ message: null }); 
                $('#all').block({ message: null }); 
                $('#filter-controls').block({ message: null });
                $('#search').block({ message: null });
            } else {
                $('#map').unblock();
                $('#all').unblock();
                $('#filter-controls').unblock();
                $('#search').unblock();
            }
        }

        function updateSearch(url){
            doBlock(true);
            //$('#search_form #zizoo_boat_search_page').val(page);

            var index   = $('#zizoo_boat_search_location :selected').index();
            var type    = null;
            var val     = null;
            var search  = null;

            if (index>0){
                type = $('#zizoo_boat_search_location option:nth-of-type('+(index+1)+')').attr('class');
                search = $('#zizoo_boat_search_location option:nth-of-type('+(index+1)+')').attr('search');
                val  = $('#zizoo_boat_search_location').val();
            }

            var urlToUse = url != null ? url : '{{ path('ZizooAddressBundle_locations') }}';
            urlToUse += '?'+$('#search_form').serialize();
            $.ajax({
                type: 'get', 
                url: urlToUse,
                success: function(data, textStatus, XHR){
                    $('#all').html(data);
                    if(val==null){
                        map.setCenter(center);
                        map.setZoom(zoom);
                    } else {
                        codeAddress(search);
                        map.setZoom(5);
                    }
                    $('#view_style').hide();
                    window.history.pushState('string', 'title', urlToUse);
                    $("#all select:not([no-select-box-it])").selectBoxIt();
                    doBlock(false);
                },
                error: function(data, textStatus, XHR){
                    doBlock(false);
                }
            });

        }

        $(document).ready(function(){

            $( "#zizoo_boat_search_reservation_from" ).attr('placeholder', 'From');
            $( "#zizoo_boat_search_reservation_to" ).attr('placeholder', 'Until');
            $( "#zizoo_boat_search_num_guests" ).attr('placeholder', 'Number of people');

            $('#all').delegate('#results-navigation a', 'click', function(){
                updateSearch($(this).attr('href'));
                return false;
            });
            
            $('#view_style').hide();
            
            $('#all').delegate('#view select[name="page_size"]', 'change', function(){
                updateSearch();
            });
            
            $('#all').delegate('#view select[name="order_by"]', 'change', function(){
                updateSearch();
            });
            
            $('#all').delegate("#view .view a", 'click', function() {
                $('#view_style').val($(this).attr('class'));
                $(this).parent().addClass("current").siblings().removeClass("current");
                $("#all .tabbed > div").eq($(this).parent().index()).show().siblings().hide();
                return false;
            });

            $('#filter-controls').show();
        });

    </script>
    
{% endblock search_filter %}
    
    
{% block search_map %}
    <div id="map"></div>
    <div id="map_div">
    </div>
{% endblock search_map %}
    

{% block zizoo_media_row %}
{% spaceless %}
    <div id="{{ id }}_container">
        {{ form_errors(form) }}
        {{ form_widget(form) }}
            
        {% if file_url is not null %}
            <div class="image_div">
                <img id="{{ id }}_image" src="{{ asset(file_url|imagine_filter('thumb_120x80')) }}?ver={{ version }}"/><br />
                <div class="overlay"></div>
                <div class="controls">
                    <a href="#" id="{{ id }}_crop_btn" class="">Crop</a>
                    {% if allow_delete == true %}
                        <a href="#" id="{{ id }}_delete_btn" class="">Delete</a>
                    {% endif %}
                    <input id="{{ id }}_full_url" type="hidden" value="{{ asset(file_url) }}" />
                </div>
            </div>
        {% endif %}
    </div>
{% endspaceless %}
{% endblock zizoo_media_row %}

{% block zizoo_media_css %}
    <style type="text/css">
        .image_div {
            position: relative;
        }
        
        .image_div .overlay {
            position: absolute;
            width: 120px;
            height: 80px;
            background-color: black;
            opacity: 0.5;
            display: none;
            left: 0;
            top: 0;
        }
        
        .image_div .controls {
            z-index: 2;
            position: absolute;
            display: none;
            left: 10px;
            top: 30px;
        }
    </style>
{% endblock zizoo_media_css %}

{% block zizoo_media_widget %}
    {% spaceless %}

    {{ block('form_widget') }}
    
    {% endspaceless %}
        
    {% if part_of_collection == false %}
    <script type="text/javascript">
        var {{ id }}_jcrop_api = null;
        
        $(document).ready(function(){

            $('#{{ id }}_delete_btn').click(function(){
                $(this).parent('.image_div').parent().remove();
            });

            $('#{{ id }}_image').Jcrop({
                onChange: {{ id }}_showCoords,
                onSelect: {{ id }}_showCoords,
                aspectRatio: {{ aspect_ratio }}
            }, function(){
                {{ id }}_jcrop_api = this;
                {{ id }}_jcrop_api.disable();
            });
            
            

            $('#{{ id }}_crop_btn').click(function(){
                var active = $(this).hasClass('active');
                if (active){
                    {{ id }}_jcrop_api.disable();
                    $(this).html('Crop');
                    $(this).removeClass('active');
                } else {
                    
                    {{ id }}_jcrop_api.enable();
                    
                    $(this).html('Done');
                    $(this).addClass('active');
                }
                
            });

        });
        
        function {{ id }}_showCoords(c){
            var prefix = '{{ id }}';
            prefix = prefix.replace('_image', '');
  
            $('#'+prefix + ' #'+prefix+'_x1').val(c.x);
            $('#'+prefix + ' #'+prefix+'_y1').val(c.y);
            $('#'+prefix + ' #'+prefix+'_x2').val(c.x2);
            $('#'+prefix + ' #'+prefix+'_y2').val(c.y2);
            $('#'+prefix + ' #'+prefix+'_w').val(c.w);
            $('#'+prefix + ' #'+prefix+'_h').val(c.h);

        }

    </script>
    {{ block('zizoo_media_css') }}
    {% endif %}
    
{% endblock zizoo_media_widget %}
    
{% block zizoo_media_collection_widget %}
    {% spaceless %}
        <div id="{{ id }}_crop_container">
            <img src="" id="{{ id }}_crop_image" />
        </div>
        <div id="{{ id }}_list">
            {% for child in form %}
                {{ form_row(child) }}
            {% endfor %}
        </div>
    {% endspaceless %}
    
    <script type="text/javascript">
        {% for child in form %}
            var {{ id }}_{{ child.vars.name }}_jcrop_api = null;
            
            function {{ id }}_{{ child.vars.name }}_showCoords(c){
                var prefix = '{{ id }}_{{ child.vars.name }}';
                prefix = prefix.replace('_image', '');

                $('#'+prefix + ' #'+prefix+'_x1').val(c.x);
                $('#'+prefix + ' #'+prefix+'_y1').val(c.y);
                $('#'+prefix + ' #'+prefix+'_x2').val(c.x2);
                $('#'+prefix + ' #'+prefix+'_y2').val(c.y2);
                $('#'+prefix + ' #'+prefix+'_w').val(c.w);
                $('#'+prefix + ' #'+prefix+'_h').val(c.h);

            }
            
        {% endfor %}
        
        function resort(){
            $('#{{ id }}_list > div').each(function(index, el){
                $(el).find('.order').val(index);
            });
        }
        
        $(document).ready(function(){
            
            resort();
            
            $('#{{ id }}_list').parents('form').submit(function(){
                $('#{{ id }}_list > div.remove').remove();
                return true;
            });
            
            $('#{{ id }}_list .image_div').hover(function(){
                $(this).children('.controls, .overlay').fadeIn();
            }, function(){
                $(this).children('.controls, .overlay').fadeOut();
            });
            
            $('#{{ id }}_list').sortable({
                stop: function(e, ui){
                    resort();
                }
            });
            
            {% for child in form %}
               
               $('#{{ id }}_{{ child.vars.name }}_delete_btn').click(function(){
                    var listItem = $(this).parent('.image_div').parent();
                    var remove = $(listItem).hasClass('remove');
                    if (remove){
                        $(listItem).removeClass('remove');
                        $(this).html('Delete');
                    } else {
                        $(listItem).addClass('remove');
                        $(this).html('Undelete');
                    }
                    
                });
               
               
                
                $('#{{ id }}_{{ child.vars.name }}_crop_btn').click(function(){
                    if ({{ id }}_{{ child.vars.name }}_jcrop_api == null) return;
                    var active = $(this).hasClass('active');
                    if (active){
                        {{ id }}_{{ child.vars.name }}_jcrop_api.disable();
                        $(this).html('Crop');
                        $(this).removeClass('active');
                    } else {
                        {{ id }}_{{ child.vars.name }}_jcrop_api.enable();
                        $(this).html('Done');
                        $(this).addClass('active');
                    }
                    return false;
                });
               
            {% endfor %}
        });
        
    </script>
    {{ block('zizoo_media_css') }}
{% endblock zizoo_media_collection_widget %}